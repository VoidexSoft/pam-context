---
phase: 01-singleton-lifecycle-tooling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/pam/ingestion/stores/elasticsearch_store.py
  - src/pam/agent/duckdb_service.py
  - src/pam/common/cache.py
  - src/pam/ingestion/embedders/openai_embedder.py
  - src/pam/ingestion/chunkers/hybrid_chunker.py
  - src/pam/retrieval/hybrid_search.py
  - src/pam/retrieval/haystack_search.py
  - src/pam/agent/agent.py
autonomous: true

must_haves:
  truths:
    - "All service constructors accept config as required params with no fallback to settings"
    - "INDEX_MAPPING is computed lazily via a function, not at import time"
    - "DuckDB service detects file changes and refreshes its table cache"
    - "CacheService TTL params are required with no settings fallback"
    - "Ruff runs with expanded rule sets (B, S, SIM, ARG, PT, RET, PERF, RUF) and passes cleanly"
    - "mypy runs with check_untyped_defs, warn_unreachable, pydantic.mypy plugin and passes cleanly"
  artifacts:
    - path: "pyproject.toml"
      provides: "Expanded ruff and mypy configuration"
      contains: "extend-immutable-calls"
    - path: "src/pam/ingestion/stores/elasticsearch_store.py"
      provides: "Lazy INDEX_MAPPING via function"
      contains: "def get_index_mapping"
    - path: "src/pam/agent/duckdb_service.py"
      provides: "Stale cache invalidation + explicit config"
      contains: "_needs_refresh"
    - path: "src/pam/common/cache.py"
      provides: "CacheService with required TTL params"
  key_links:
    - from: "src/pam/ingestion/stores/elasticsearch_store.py"
      to: "get_index_mapping function"
      via: "ensure_index calls get_index_mapping(self._embedding_dims)"
      pattern: "get_index_mapping\\(self\\._embedding_dims\\)"
    - from: "src/pam/agent/duckdb_service.py"
      to: "data_dir mtime check"
      via: "_needs_refresh before queries"
      pattern: "_needs_refresh"
---

<objective>
Refactor all service constructors to accept explicit config (no hidden settings imports), make INDEX_MAPPING lazy, add DuckDB stale cache detection, and expand ruff/mypy linting configuration.

Purpose: Eliminates hidden settings dependencies from service modules (prerequisite for Plan 02 lifespan migration) and expands tooling to catch bug patterns across the codebase.
Output: All service classes ready for lifespan-based initialization; tooling validates the entire codebase.
</objective>

<execution_context>
@/Users/datnguyen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/datnguyen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-singleton-lifecycle-tooling/01-RESEARCH.md

@src/pam/common/cache.py
@src/pam/common/config.py
@src/pam/ingestion/stores/elasticsearch_store.py
@src/pam/ingestion/embedders/openai_embedder.py
@src/pam/ingestion/chunkers/hybrid_chunker.py
@src/pam/retrieval/hybrid_search.py
@src/pam/retrieval/haystack_search.py
@src/pam/agent/agent.py
@src/pam/agent/duckdb_service.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand ruff and mypy configuration in pyproject.toml</name>
  <files>pyproject.toml</files>
  <action>
Update `[tool.ruff.lint]` select to add rule categories: B, S, SIM, ARG, PT, RET, PERF, RUF. Do NOT add FAST (FAST002 has 38 violations requiring Annotated migration -- deferred per research).

Add `[tool.ruff.lint.flake8-bugbear]` section with `extend-immutable-calls` for FastAPI DI calls:
```toml
[tool.ruff.lint.flake8-bugbear]
extend-immutable-calls = ["fastapi.Depends", "fastapi.Query", "fastapi.Path", "fastapi.Body", "fastapi.Header"]
```

Add `[tool.ruff.lint.per-file-ignores]` for test files:
```toml
[tool.ruff.lint.per-file-ignores]
"tests/**" = ["S101", "S106", "S108", "ARG001", "ARG002", "ARG005", "PT019"]
```

Add `pytest-randomly>=3.0` to the `[project.optional-dependencies] dev` list.

Update `[tool.mypy]` to add:
```toml
check_untyped_defs = true
warn_unreachable = true
plugins = ["pydantic.mypy"]
```

Add `[tool.pydantic-mypy]` section:
```toml
[tool.pydantic-mypy]
init_forbid_extra = true
init_typed = true
warn_required_dynamic_aliases = true
```

Do NOT add the SQLAlchemy mypy plugin -- it is deprecated and incompatible with mypy >=1.11.

Then run `ruff check src/ tests/` and fix all violations. Expected fixes:
- B905: Add `strict=True` to ~6 `zip()` calls in src/
- B904: Add `from e` to ~4 `raise` in except blocks in src/
- PERF401: Convert ~5 list appends to comprehensions in src/ and ~5 in tests/
- ARG001/ARG002: Prefix ~4 unused args with `_` in src/ (tests are covered by per-file-ignores)
- RET504/RET505: Fix ~3 return-related issues in src/
- S105: Evaluate 2 hardcoded password strings in src/ (likely settings defaults -- add `# noqa: S105` if appropriate)
- S608: Add `# noqa: S608` to DuckDB service SQL construction lines (intentional SQL building with guards)
- PT011: Narrow ~2 `pytest.raises()` match patterns in tests/

Then run `mypy src/pam/` and fix any violations (expected: only ~1 unreachable statement in google_docs.py).

Install pytest-randomly: `pip install pytest-randomly` and update lock file if applicable.
  </action>
  <verify>
Run `ruff check src/ tests/` -- zero violations.
Run `mypy src/pam/` -- zero errors.
Run `pytest tests/ -x -q` -- all tests pass (no regressions from code fixes).
  </verify>
  <done>Ruff passes with B, S, SIM, ARG, PT, RET, PERF, RUF rule categories enabled. mypy passes with check_untyped_defs, warn_unreachable, and pydantic.mypy plugin. pytest-randomly is installed as a dev dependency.</done>
</task>

<task type="auto">
  <name>Task 2: Make all service constructors accept explicit config parameters</name>
  <files>
    src/pam/common/cache.py
    src/pam/ingestion/stores/elasticsearch_store.py
    src/pam/ingestion/embedders/openai_embedder.py
    src/pam/ingestion/chunkers/hybrid_chunker.py
    src/pam/retrieval/hybrid_search.py
    src/pam/retrieval/haystack_search.py
    src/pam/agent/agent.py
    src/pam/agent/duckdb_service.py
  </files>
  <action>
For each service class, remove the `settings` fallback pattern (where `param or settings.value` is used in constructors) and make all config params required. Remove `from pam.common.config import settings` from each module if it becomes unused after the change.

**CacheService** (`src/pam/common/cache.py`):
- Change constructor: `search_ttl: int | None = None` and `session_ttl: int | None = None` become `search_ttl: int` and `session_ttl: int` (required, no default).
- Remove the `settings` fallback in the `search_ttl` and `session_ttl` properties. Properties just return `self._search_ttl` and `self._session_ttl` directly.
- Remove `from pam.common.config import settings` from cache.py ONLY if the module-level `get_redis()` function is the sole remaining user. Note: `get_redis()` still uses `settings.redis_url` -- this will be addressed in Plan 02 when Redis creation moves to lifespan. For now, keep the settings import if `get_redis()` still needs it.

**ElasticsearchStore** (`src/pam/ingestion/stores/elasticsearch_store.py`):
- Convert module-level `INDEX_MAPPING` dict into a function: `def get_index_mapping(embedding_dims: int) -> dict:` that returns the same structure but with `embedding_dims` as a parameter instead of `settings.embedding_dims`.
- Add `embedding_dims: int` as a required constructor param (no default). Store as `self._embedding_dims`.
- Change `index_name: str | None = None` to `index_name: str` (required, no default). Remove `or settings.elasticsearch_index` fallback.
- Update `ensure_index()` to call `get_index_mapping(self._embedding_dims)` instead of using the module-level constant.
- Remove `from pam.common.config import settings` since it will be unused.

**OpenAIEmbedder** (`src/pam/ingestion/embedders/openai_embedder.py`):
- Change `api_key: str | None = None` to `api_key: str` (required). Remove `or settings.openai_api_key`.
- Change `model: str | None = None` to `model: str` (required). Remove `or settings.embedding_model`.
- Change `dims: int | None = None` to `dims: int` (required). Remove `or settings.embedding_dims`.
- Remove `from pam.common.config import settings`.

**hybrid_chunker** (`src/pam/ingestion/chunkers/hybrid_chunker.py`):
- Change `max_tokens: int | None = None` to `max_tokens: int` (required). Remove `or settings.chunk_size_tokens`.
- Remove `from pam.common.config import settings`.

**HybridSearchService** (`src/pam/retrieval/hybrid_search.py`):
- Change `index_name: str | None = None` to `index_name: str` (required). Remove `or settings.elasticsearch_index`.
- Remove `from pam.common.config import settings`.

**HaystackSearchService** (`src/pam/retrieval/haystack_search.py`):
- Change `es_url: str | None = None` to `es_url: str` (required). Remove `or settings.elasticsearch_url`.
- Change `index_name: str | None = None` to `index_name: str` (required). Remove `or settings.elasticsearch_index`.
- Change `rerank_model: str | None = None` to `rerank_model: str` (required). Remove `or settings.rerank_model`.
- Remove `from pam.common.config import settings`.

**RetrievalAgent** (`src/pam/agent/agent.py`):
- Check constructor for `settings` fallbacks (likely `api_key` and `model`). Make them required params. Remove `from pam.common.config import settings` if unused.

**DuckDBService** (`src/pam/agent/duckdb_service.py`):
- Change `data_dir: str | None = None` to `data_dir: str` (required). Remove fallback to `settings.duckdb_data_dir`.
- Change `max_rows: int | None = None` to `max_rows: int` (required). Remove fallback to `settings.duckdb_max_rows`.
- Add stale cache invalidation: add `_last_scan_mtime: float = 0.0` instance variable. Add `_needs_refresh() -> bool` method that compares `self.data_dir.stat().st_mtime` to `_last_scan_mtime`. Update `register_files()` to record `_last_scan_mtime = self.data_dir.stat().st_mtime` after scanning. Add `_needs_refresh()` check at the start of `execute_query()` and `list_tables()` -- if True, call `register_files()`.
- Remove `from pam.common.config import settings`.

**IMPORTANT:** After changing constructor signatures, grep for all call sites across the codebase (tests, routes, other modules) and update them to pass the now-required parameters explicitly. Key call sites to check:
- `ElasticsearchStore(es_client)` in `main.py` lifespan and `task_manager.py` -- add `index_name=` and `embedding_dims=` params (use `settings.*` at the call site for now; Plan 02 will pass from lifespan)
- `CacheService(redis_client)` in `deps.py` and `task_manager.py` -- add `search_ttl=` and `session_ttl=` (use `settings.*` at call site for now)
- `OpenAIEmbedder()` in `deps.py` -- add all 3 required params
- `DuckDBService()` in `deps.py` -- add `data_dir=` and `max_rows=`
- `HybridSearchService(es_client, ...)` in `deps.py` -- add `index_name=`
- `HaystackSearchService(...)` in `deps.py` -- add all required params
- `chunk_document(doc)` calls -- add `max_tokens=` param
- Test files that construct these services directly -- update constructor calls

For tests, pass reasonable test values (e.g., `search_ttl=900`, `index_name="test_index"`, `embedding_dims=1536`, `data_dir="/tmp/test"`, `max_rows=100`).
  </action>
  <verify>
Run `ruff check src/ tests/` -- zero violations.
Run `mypy src/pam/` -- zero errors.
Run `pytest tests/ -x -q` -- all tests pass.
Grep for `from pam.common.config import settings` in the 8 modified service modules -- should only remain in cache.py (for get_redis) and nowhere else.
  </verify>
  <done>
All service constructors accept config as required parameters. No constructor uses `param or settings.value` fallback pattern. INDEX_MAPPING is computed via `get_index_mapping(embedding_dims)` function. DuckDB service has `_needs_refresh()` mtime-based cache invalidation. CacheService TTL params are required with no settings fallback. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `ruff check src/ tests/` reports zero violations with expanded rule set
2. `mypy src/pam/` reports zero errors with expanded configuration
3. `pytest tests/ -x -q` passes all tests
4. `grep -r "from pam.common.config import settings" src/pam/ingestion/stores/elasticsearch_store.py src/pam/ingestion/embedders/openai_embedder.py src/pam/ingestion/chunkers/hybrid_chunker.py src/pam/retrieval/hybrid_search.py src/pam/retrieval/haystack_search.py src/pam/agent/agent.py src/pam/agent/duckdb_service.py` returns no matches (settings import removed from all refactored modules)
5. `grep -rn "or settings\." src/pam/common/cache.py src/pam/ingestion/ src/pam/retrieval/ src/pam/agent/` returns no matches in constructor/init methods
</verification>

<success_criteria>
- All 8 service modules have explicit-only constructor parameters
- INDEX_MAPPING is a function, not a module-level constant
- DuckDB stale cache detection works via mtime comparison
- Ruff and mypy pass with expanded configurations
- All 450+ existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-singleton-lifecycle-tooling/01-01-SUMMARY.md`
</output>
