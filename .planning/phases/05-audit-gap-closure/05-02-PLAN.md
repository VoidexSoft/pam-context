---
phase: 05-audit-gap-closure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - web/src/api/client.ts
  - web/src/hooks/useChat.ts
  - web/src/hooks/useChat.test.ts
  - web/src/api/client.test.ts
  - web/src/components/MessageBubble.tsx
autonomous: true
requirements:
  - TOOL-02
  - AGNT-04

must_haves:
  truths:
    - "getAuthStatus() and listTasks() are removed from client.ts — no dead API functions"
    - "ChatResponse interface matches backend: {response, citations, conversation_id, token_usage, latency_ms}"
    - "Non-streaming fallback path in useChat.ts correctly reads response field and constructs ChatMessage"
    - "SSE done handler reads conversation_id from top-level event field"
    - "Metrics (token_usage, latency_ms) attach to assistant messages on both streaming and non-streaming paths"
    - "Expandable metrics details section appears below assistant messages that have token_usage"
    - "All existing frontend tests pass with updated mocks"
  artifacts:
    - path: "web/src/api/client.ts"
      provides: "Aligned ChatResponse, updated StreamEvent, no dead functions"
    - path: "web/src/hooks/useChat.ts"
      provides: "Fixed fallback path, metrics wiring, top-level conversation_id read"
    - path: "web/src/components/MessageBubble.tsx"
      provides: "Expandable details section for token_usage and latency_ms"
    - path: "web/src/hooks/useChat.test.ts"
      provides: "Updated test mocks matching new ChatResponse shape"
    - path: "web/src/api/client.test.ts"
      provides: "Updated test mocks matching new ChatResponse shape"
  key_links:
    - from: "web/src/hooks/useChat.ts"
      to: "web/src/api/client.ts"
      via: "Non-streaming fallback reads ChatResponse fields"
      pattern: "res\\.response"
    - from: "web/src/hooks/useChat.ts"
      to: "web/src/api/client.ts"
      via: "SSE done handler reads event.conversation_id"
      pattern: "event\\.conversation_id"
    - from: "web/src/components/MessageBubble.tsx"
      to: "web/src/api/client.ts"
      via: "Reads ChatMessage.token_usage and .latency_ms"
      pattern: "message\\.token_usage"
---

<objective>
Remove dead frontend functions, align ChatResponse interface with backend, wire conversation_id and metrics through both streaming and non-streaming paths, and add expandable metrics display.

Purpose: Close remaining audit gaps — dead code in client.ts, broken non-streaming fallback, missing metrics display, and conversation_id not preserved across turns.

Output: 5 frontend files updated — client.ts cleaned and aligned, useChat.ts wired correctly, MessageBubble.tsx shows metrics, tests updated.
</objective>

<execution_context>
@/Users/datnguyen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/datnguyen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-audit-gap-closure/05-RESEARCH.md
@web/src/api/client.ts
@web/src/hooks/useChat.ts
@web/src/hooks/useChat.test.ts
@web/src/api/client.test.ts
@web/src/components/MessageBubble.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove dead functions, align ChatResponse and StreamEvent interfaces, fix useChat non-streaming fallback and metrics wiring</name>
  <files>
    web/src/api/client.ts
    web/src/hooks/useChat.ts
    web/src/hooks/useChat.test.ts
    web/src/api/client.test.ts
  </files>
  <action>
**client.ts — Remove dead functions:**

1. Delete the `listTasks()` function (currently lines 234-239). It is exported but never imported anywhere in the codebase.
2. Delete the `getAuthStatus()` function (currently lines 256-258). It calls a non-existent `/api/auth/status` endpoint.

**client.ts — Update ChatMessage interface:**

Add optional metrics fields to `ChatMessage`:
```typescript
export interface ChatMessage {
  id?: string;
  role: "user" | "assistant";
  content: string;
  citations?: Citation[];
  token_usage?: Record<string, number>;
  latency_ms?: number;
}
```

**client.ts — Update ChatResponse interface:**

Replace the current ChatResponse to match the backend `ChatResponse` Pydantic model exactly (backend is source of truth per user decision):
```typescript
export interface ChatResponse {
  response: string;
  citations: Array<{
    document_title?: string;
    section_path?: string;
    source_url?: string;
    segment_id?: string;
  }>;
  conversation_id: string | null;
  token_usage: Record<string, number>;
  latency_ms: number;
}
```

**client.ts — Update StreamEvent interface:**

Add `conversation_id` as a **top-level** field (per user decision — backend puts it at top level of done event, NOT nested in metadata):
```typescript
export interface StreamEvent {
  type: StreamEventType;
  content?: string;
  data?: Citation;
  message?: string;
  conversation_id?: string;  // Top-level in done events
  metadata?: {
    token_usage: Record<string, number>;
    latency_ms: number;
    tool_calls: number;
  };
}
```
Remove `conversation_id` from inside `metadata` — it is no longer nested there.

**useChat.ts — Fix the SSE done handler (around line 108-111):**

Update to read `conversation_id` from the top-level event field AND attach metrics to the last assistant message:
```typescript
case "done":
  if (event.conversation_id) {
    setConversationId(event.conversation_id);
  }
  // Attach metrics to the last assistant message
  if (event.metadata) {
    setMessages((prev) => {
      const updated = [...prev];
      const last = updated[updated.length - 1];
      if (last?.role === "assistant") {
        updated[updated.length - 1] = {
          ...last,
          token_usage: event.metadata!.token_usage,
          latency_ms: event.metadata!.latency_ms,
        };
      }
      return updated;
    });
  }
  break;
```

**useChat.ts — Fix the non-streaming fallback path (around line 148-150):**

Replace the current code that reads `res.message` (which does not exist in the new ChatResponse) with:
```typescript
if (res.conversation_id) setConversationId(res.conversation_id);
const assistantMsg: ChatMessage = {
  id: crypto.randomUUID(),
  role: "assistant",
  content: res.response,
  citations: res.citations?.map((c) => ({
    title: c.document_title ?? "",
    document_id: c.document_title ?? "",
    source_url: c.source_url,
    segment_id: c.segment_id,
  })),
  token_usage: res.token_usage,
  latency_ms: res.latency_ms,
};
setMessages((prev) => [...prev, assistantMsg]);
```

Note: The `ChatResponse` import needs to be added to the import list in useChat.ts: add `ChatResponse` to the import from `"../api/client"`.

**useChat.test.ts — Update the fallback mock (around line 99-102):**

Change the mock to match the new ChatResponse shape:
```typescript
mockSendMessage.mockResolvedValue({
  response: "fallback response",
  citations: [],
  conversation_id: "conv-fallback",
  token_usage: { input_tokens: 100, output_tokens: 50, total_tokens: 150 },
  latency_ms: 200,
});
```

Update the assertion at line 112 to verify the content is read from `response`:
```typescript
expect(result.current.messages[1].content).toBe("fallback response");
```

**client.test.ts — Update the sendMessage mock (around line 93-101):**

Change the mock response to match the new ChatResponse shape:
```typescript
beforeEach(() => {
  fetchSpy.mockResolvedValue({
    ok: true,
    json: () =>
      Promise.resolve({
        response: "hi",
        citations: [],
        conversation_id: "conv-1",
        token_usage: { input_tokens: 10, output_tokens: 5, total_tokens: 15 },
        latency_ms: 50,
      }),
  } as unknown as Response);
});
```
  </action>
  <verify>
Run: `cd /Users/datnguyen/Projects/AI-Projects/pam-context/web && npx vitest run --reporter=verbose 2>&1 | tail -30`

Verify dead functions removed: `grep -n "getAuthStatus\|listTasks" web/src/api/client.ts` should return nothing.

Verify ChatResponse shape: `grep -A5 "export interface ChatResponse" web/src/api/client.ts` should show `response: string` (not `message: ChatMessage`).

Verify StreamEvent has top-level conversation_id: `grep "conversation_id" web/src/api/client.ts` should show it at StreamEvent top level.
  </verify>
  <done>
- `getAuthStatus()` and `listTasks()` deleted from client.ts
- ChatResponse interface matches backend: `{response, citations, conversation_id, token_usage, latency_ms}`
- ChatMessage extended with optional `token_usage` and `latency_ms`
- StreamEvent has top-level `conversation_id` field
- useChat.ts done handler reads `event.conversation_id` (top-level) and attaches metrics to last assistant message
- useChat.ts non-streaming fallback reads `res.response`, maps citations, attaches metrics
- All test mocks updated to match new ChatResponse shape
- All frontend tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Add expandable metrics details section to MessageBubble</name>
  <files>
    web/src/components/MessageBubble.tsx
  </files>
  <action>
Add an expandable `<details>` section below assistant messages that have `token_usage` or `latency_ms` set. Use native HTML `<details>/<summary>` (per research — built-in accessibility, no JS state needed) with Tailwind styling.

**In MessageBubble.tsx**, after the citations block (around line 63, before the closing `</div>` of the bubble), add:

```tsx
{!isUser && (message.token_usage || message.latency_ms) && (
  <details className="mt-2 pt-2 border-t border-gray-200/20 dark:border-zinc-700/50">
    <summary className="text-xs text-gray-400 dark:text-zinc-500 cursor-pointer hover:text-gray-500 dark:hover:text-zinc-400 select-none list-none flex items-center gap-1">
      <span className="text-[10px]">&#9662;</span>
      {message.latency_ms != null && `${(message.latency_ms / 1000).toFixed(1)}s`}
      {message.latency_ms != null && message.token_usage?.total_tokens != null && " · "}
      {message.token_usage?.total_tokens != null && `${message.token_usage.total_tokens} tokens`}
    </summary>
    <div className="mt-1 text-xs text-gray-400 dark:text-zinc-500 space-y-0.5">
      {message.token_usage?.input_tokens != null && (
        <div>Input: {message.token_usage.input_tokens.toLocaleString()} tokens</div>
      )}
      {message.token_usage?.output_tokens != null && (
        <div>Output: {message.token_usage.output_tokens.toLocaleString()} tokens</div>
      )}
      {message.token_usage?.total_tokens != null && (
        <div>Total: {message.token_usage.total_tokens.toLocaleString()} tokens</div>
      )}
      {message.latency_ms != null && (
        <div>Latency: {message.latency_ms.toLocaleString()}ms</div>
      )}
    </div>
  </details>
)}
```

Key design choices (per user decisions):
- **Hidden by default** — `<details>` is collapsed natively
- **Expandable on click** — no React state needed
- Use `list-none` on `<summary>` to hide default disclosure triangle, use custom `&#9662;` triangle character
- Dark mode support via `dark:` Tailwind variants
- Token counts use `toLocaleString()` for thousands separator
- Summary line shows compact format: "1.2s · 1,500 tokens"

Do NOT add any React state or JavaScript toggle logic — the native `<details>` element handles open/close.
  </action>
  <verify>
Run: `cd /Users/datnguyen/Projects/AI-Projects/pam-context/web && npx tsc --noEmit 2>&1 | tail -10` to verify TypeScript compiles clean.

Run: `cd /Users/datnguyen/Projects/AI-Projects/pam-context/web && npx vitest run --reporter=verbose 2>&1 | tail -10` to verify all tests still pass.

Verify the details element exists: `grep -n "<details" web/src/components/MessageBubble.tsx` should return a match.
  </verify>
  <done>
- Assistant messages with token_usage show an expandable details section
- Section is hidden by default and expands on click
- Shows latency and token breakdown (input/output/total)
- Compact summary line: "1.2s · 1,500 tokens"
- Works in both light and dark mode
- No JavaScript toggle state — pure native `<details>/<summary>`
  </done>
</task>

</tasks>

<verification>
```bash
# 1. Dead functions removed
grep -n "getAuthStatus\|listTasks" web/src/api/client.ts  # Should return nothing

# 2. ChatResponse aligned with backend
grep -A6 "export interface ChatResponse" web/src/api/client.ts  # Should show response, citations, conversation_id, token_usage, latency_ms

# 3. StreamEvent has top-level conversation_id
grep "conversation_id" web/src/api/client.ts  # Check it's at top level of StreamEvent

# 4. Non-streaming fallback reads correct fields
grep "res.response" web/src/hooks/useChat.ts  # Should appear in fallback path
grep "res.message" web/src/hooks/useChat.ts   # Should NOT appear

# 5. Metrics display exists
grep "<details" web/src/components/MessageBubble.tsx  # Should return a match

# 6. TypeScript compiles
cd /Users/datnguyen/Projects/AI-Projects/pam-context/web && npx tsc --noEmit

# 7. All frontend tests pass
cd /Users/datnguyen/Projects/AI-Projects/pam-context/web && npx vitest run
```
</verification>

<success_criteria>
1. `grep "getAuthStatus\|listTasks" web/src/api/client.ts` returns empty — no dead functions
2. ChatResponse interface has `response: string` (not `message: ChatMessage`)
3. `npx tsc --noEmit` succeeds with zero errors
4. `npx vitest run` passes all tests including updated mocks
5. MessageBubble.tsx contains an expandable `<details>` section for metrics
</success_criteria>

<output>
After completion, create `.planning/phases/05-audit-gap-closure/05-02-SUMMARY.md`
</output>
