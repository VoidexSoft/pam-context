---
phase: 06-neo4j-graphiti-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker-compose.yml
  - pyproject.toml
  - src/pam/common/config.py
  - src/pam/graph/__init__.py
  - src/pam/graph/entity_types.py
  - src/pam/graph/service.py
  - .env.example
autonomous: true
requirements: [INFRA-01, INFRA-02, INFRA-05]

must_haves:
  truths:
    - "docker compose up starts Neo4j alongside existing services and Neo4j passes health check within 30 seconds"
    - "Python code can from graphiti_core import Graphiti without import errors"
    - "Entity type taxonomy exists as 7 Pydantic models importable from src/pam/graph/"
    - "ENTITY_TYPES dict has exactly 7 entries and no protected field names"
  artifacts:
    - path: "docker-compose.yml"
      provides: "Neo4j service definition with health check, memory config, APOC plugin"
      contains: "neo4j:5.26-community"
    - path: "pyproject.toml"
      provides: "graphiti-core[anthropic] dependency"
      contains: "graphiti-core"
    - path: "src/pam/common/config.py"
      provides: "Neo4j and Graphiti settings fields"
      contains: "neo4j_uri"
    - path: "src/pam/graph/__init__.py"
      provides: "Graph module re-exports"
    - path: "src/pam/graph/entity_types.py"
      provides: "7 entity type Pydantic models + ENTITY_TYPES registry dict"
      contains: "ENTITY_TYPES"
    - path: "src/pam/graph/service.py"
      provides: "GraphitiService wrapper class with create() factory and close()"
      contains: "class GraphitiService"
    - path: ".env.example"
      provides: "Neo4j and Graphiti env var documentation"
      contains: "NEO4J_URI"
  key_links:
    - from: "src/pam/graph/service.py"
      to: "src/pam/common/config.py"
      via: "Settings fields neo4j_uri, neo4j_user, neo4j_password, graphiti_model"
      pattern: "neo4j_uri|neo4j_user|neo4j_password"
    - from: "src/pam/graph/entity_types.py"
      to: "graphiti_core"
      via: "Pydantic models compatible with add_episode entity_types parameter"
      pattern: "dict\\[str, type\\[BaseModel\\]\\]"
---

<objective>
Stand up Neo4j Docker service, install graphiti-core Python dependency, add Neo4j/Graphiti settings to config, create the graph module with entity type taxonomy and GraphitiService wrapper class.

Purpose: Provides all the foundational pieces (Docker service, Python package, config, entity schema, service class) needed before wiring into FastAPI lifecycle in Plan 02.
Output: Neo4j running in Docker Compose, graphiti-core importable, 7 entity types defined, GraphitiService class ready to instantiate.
</objective>

<execution_context>
@/Users/datnguyen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/datnguyen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-neo4j-graphiti-infrastructure/06-CONTEXT.md
@.planning/phases/06-neo4j-graphiti-infrastructure/06-RESEARCH.md
@docker-compose.yml
@pyproject.toml
@src/pam/common/config.py
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Docker Compose Neo4j + Python dependency + Settings</name>
  <files>
    docker-compose.yml
    pyproject.toml
    src/pam/common/config.py
    .env.example
  </files>
  <action>
1. Add Neo4j service to docker-compose.yml after the redis service block:
   - Image: `neo4j:5.26-community`
   - Environment: `NEO4J_AUTH=neo4j/pam_graph`, `NEO4J_PLUGINS=["apoc"]`, `NEO4J_server_memory_heap_initial__size=512m`, `NEO4J_server_memory_heap_max__size=1G`, `NEO4J_server_memory_pagecache_size=512m`, `NEO4J_dbms_security_procedures_unrestricted=apoc.*`
   - Ports: `7474:7474` (browser), `7687:7687` (bolt)
   - Volume: `neo4jdata:/var/lib/neo4j/data`
   - Healthcheck: `cypher-shell -u neo4j -p pam_graph "RETURN 1"` with interval=10s, timeout=5s, retries=5, start_period=30s
   - Add `neo4jdata:` to the volumes section

2. Add graphiti-core[anthropic] to pyproject.toml dependencies:
   - Add `"graphiti-core[anthropic]>=0.27",` in the dependencies list, add a `# Graph` comment section before it (similar to existing `# Cache`, `# Auth` groupings)

3. Add Neo4j + Graphiti settings to src/pam/common/config.py Settings class:
   - `neo4j_uri: str = "bolt://localhost:7687"` (default for local dev against Docker)
   - `neo4j_user: str = "neo4j"`
   - `neo4j_password: str = "pam_graph"`
   - `graphiti_model: str = "claude-sonnet-4-5-20250514"` (uses same model as agent)
   - `graphiti_embedding_model: str = "text-embedding-3-small"` (separate from main embedding model -- Graphiti uses its own embedder)
   - Add a `# Neo4j / Graphiti` comment section before these fields

4. Add Neo4j + Graphiti env vars to .env.example:
   - Add a `# Neo4j` section with `NEO4J_URI=bolt://localhost:7687`, `NEO4J_USER=neo4j`, `NEO4J_PASSWORD=pam_graph`
   - Add a `# Graphiti` section with `GRAPHITI_MODEL=claude-sonnet-4-5-20250514`, `GRAPHITI_EMBEDDING_MODEL=text-embedding-3-small`
   - Add a `# Graph UI` section with `VITE_GRAPH_ENABLED=false`

After editing pyproject.toml, run `uv lock` to update uv.lock, then `uv sync` to install graphiti-core.
  </action>
  <verify>
- `docker compose config` exits 0 (valid compose file)
- `docker compose up -d neo4j` starts Neo4j, then `docker compose exec neo4j cypher-shell -u neo4j -p pam_graph "RETURN 1"` returns 1 (may need to wait up to 30s for health check)
- `python -c "from graphiti_core import Graphiti; print('OK')"` prints OK
- `python -c "from pam.common.config import Settings; s = Settings(); print(s.neo4j_uri)"` prints bolt://localhost:7687
  </verify>
  <done>Neo4j container runs healthy in Docker Compose, graphiti-core is importable, and Settings class has all Neo4j/Graphiti fields with defaults.</done>
</task>

<task type="auto">
  <name>Task 2: Graph module -- entity types + GraphitiService</name>
  <files>
    src/pam/graph/__init__.py
    src/pam/graph/entity_types.py
    src/pam/graph/service.py
  </files>
  <action>
1. Create `src/pam/graph/` directory with `__init__.py`.

2. Create `src/pam/graph/entity_types.py` with 7 entity type Pydantic models per user decision:
   - Person: role (Optional[str]), department (Optional[str])
   - Team: team_type (Optional[str]), size (Optional[int])
   - Project: project_type (Optional[str]), status (Optional[str]), platform (Optional[str])
   - Technology: tech_category (Optional[str]), version (Optional[str])
   - Process: process_type (Optional[str]), frequency (Optional[str])
   - Concept: concept_type (Optional[str]), maturity (Optional[str])
   - Asset: asset_type (Optional[str]), format (Optional[str])
   - CRITICAL: None of the field names may be: uuid, name, group_id, labels, created_at, summary, attributes, name_embedding (Graphiti protected fields)
   - All fields Optional with Field(None, description="...") -- Graphiti expects optional attributes
   - Each model has a docstring describing what it represents in a game studio domain
   - Export `ENTITY_TYPES: dict[str, type[BaseModel]]` mapping all 7 type names to their model classes
   - Use `from __future__ import annotations` at the top

3. Create `src/pam/graph/service.py` with GraphitiService class:
   - `__init__(self, client: Graphiti) -> None` stores `_client`
   - `@classmethod async def create(cls, neo4j_uri, neo4j_user, neo4j_password, anthropic_api_key, openai_api_key, anthropic_model, embedding_model) -> GraphitiService` -- creates Graphiti instance with AnthropicClient (LLMConfig with api_key + model) and OpenAIEmbedder (OpenAIEmbedderConfig with api_key + embedding_model), calls `await client.build_indices_and_constraints()`, logs `graphiti_initialized`, returns `cls(client)`
   - `@property client(self) -> Graphiti` returns `_client`
   - `async def close(self) -> None` calls `await self._client.close()` and logs `graphiti_closed`
   - Use structlog for logging: `logger = structlog.get_logger()`
   - Import from `graphiti_core.llm_client.anthropic_client import AnthropicClient` and `graphiti_core.llm_client.config import LLMConfig` and `graphiti_core.embedder.openai import OpenAIEmbedder, OpenAIEmbedderConfig`

4. Create `src/pam/graph/__init__.py` that re-exports:
   - `ENTITY_TYPES` from entity_types
   - `GraphitiService` from service
   - All 7 entity type classes from entity_types
   - Keep it minimal -- just the imports and `__all__` list

Ensure all files pass `ruff check` (use `from __future__ import annotations`, proper import ordering, docstrings on all public classes/methods).
  </action>
  <verify>
- `python -c "from pam.graph import GraphitiService, ENTITY_TYPES; print(len(ENTITY_TYPES))"` prints 7
- `python -c "from pam.graph.entity_types import ENTITY_TYPES; print(sorted(ENTITY_TYPES.keys()))"` prints the 7 type names
- `python -c "from pam.graph.entity_types import ENTITY_TYPES; protected = {'uuid','name','group_id','labels','created_at','summary','attributes','name_embedding'}; fields = {f for m in ENTITY_TYPES.values() for f in m.model_fields}; overlap = fields & protected; assert not overlap, f'Protected fields used: {overlap}'; print('No protected field conflicts')"` prints no conflicts
- `ruff check src/pam/graph/` passes
  </verify>
  <done>Graph module exists at src/pam/graph/ with 7 entity types matching user decision (Person, Team, Project, Technology, Process, Concept, Asset), ENTITY_TYPES registry dict, and GraphitiService wrapper class with create()/close() lifecycle methods.</done>
</task>

</tasks>

<verification>
- Docker Compose config valid and Neo4j starts with health check passing
- graphiti-core importable from Python
- All 7 entity types defined with no protected field name collisions
- GraphitiService class has create() factory and close() methods
- Settings class has neo4j_uri, neo4j_user, neo4j_password, graphiti_model, graphiti_embedding_model
- All new Python code passes ruff check
</verification>

<success_criteria>
- `docker compose up neo4j` starts and health check passes
- `from graphiti_core import Graphiti` works
- `from pam.graph import GraphitiService, ENTITY_TYPES` imports successfully
- ENTITY_TYPES has exactly 7 entries with zero protected field name collisions
- Settings().neo4j_uri returns default bolt://localhost:7687
</success_criteria>

<output>
After completion, create `.planning/phases/06-neo4j-graphiti-infrastructure/06-01-SUMMARY.md`
</output>
