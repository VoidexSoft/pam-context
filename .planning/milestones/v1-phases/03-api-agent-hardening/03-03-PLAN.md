---
phase: 03-api-agent-hardening
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/pam/agent/tools.py
  - src/pam/common/logging.py
  - src/pam/common/cache.py
  - src/pam/retrieval/hybrid_search.py
  - src/pam/retrieval/search_protocol.py
  - src/pam/retrieval/haystack_search.py
  - src/pam/api/deps.py
autonomous: true

must_haves:
  truths:
    - "Agent tool schemas include required fields where appropriate (QUERY_DATABASE_TOOL required=[] fix)"
    - "CostTracker logs a warning with the model name when encountering an unknown model"
    - "Cache key hash uses full SHA-256 (64 hex chars) instead of truncated 16 chars"
    - "hybrid_search.py log is emitted after reranking, not before"
    - "SearchService Protocol enables type-safe polymorphism between HybridSearchService and HaystackSearchService"
  artifacts:
    - path: "src/pam/agent/tools.py"
      provides: "Corrected tool schemas with required fields"
      contains: "required"
    - path: "src/pam/common/logging.py"
      provides: "CostTracker with unknown model warning"
      contains: "Unknown model"
    - path: "src/pam/common/cache.py"
      provides: "Full SHA-256 cache key hash"
      contains: "hexdigest()"
    - path: "src/pam/retrieval/search_protocol.py"
      provides: "SearchService Protocol class"
      contains: "class SearchService"
    - path: "src/pam/retrieval/hybrid_search.py"
      provides: "Log emitted after reranking"
      contains: "hybrid_search"
  key_links:
    - from: "src/pam/retrieval/search_protocol.py"
      to: "src/pam/api/deps.py"
      via: "SearchService type hint for get_search_service return"
      pattern: "SearchService"
    - from: "src/pam/retrieval/search_protocol.py"
      to: "src/pam/retrieval/hybrid_search.py"
      via: "HybridSearchService structurally conforms to SearchService Protocol"
      pattern: "search"
---

<objective>
Fix agent tool schemas with correct required fields, add CostTracker warning for unknown models, use full SHA-256 for cache keys, move hybrid_search log after reranking, and define a SearchService Protocol for type-safe polymorphism.

Purpose: These are independent correctness and observability fixes across the agent and retrieval layers. Tool schema bugs cause Claude to call tools with missing arguments. Silent cost fallback hides billing surprises. Truncated cache hashes have unnecessary collision risk. The search service lacks a formal interface, making deps.py type hints incorrect when Haystack is active.

Output: Fixed tools.py schemas, enhanced logging.py CostTracker, full-hash cache.py, post-rerank hybrid_search.py log, new search_protocol.py Protocol, updated deps.py type hints.
</objective>

<execution_context>
@/Users/datnguyen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/datnguyen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-api-agent-hardening/03-RESEARCH.md
@src/pam/agent/tools.py
@src/pam/common/logging.py
@src/pam/common/cache.py
@src/pam/retrieval/hybrid_search.py
@src/pam/retrieval/haystack_search.py
@src/pam/api/deps.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix tool schemas, CostTracker warning, and cache key hash</name>
  <files>
    src/pam/agent/tools.py
    src/pam/common/logging.py
    src/pam/common/cache.py
  </files>
  <action>
    **Fix tool schemas in `tools.py` (AGNT-01):**

    `QUERY_DATABASE_TOOL`: Currently has `"required": ["sql"]` but the handler accepts `list_tables=True` without `sql`. Fix by setting `"required": []` (empty list). The handler at agent.py already validates that at least one of `sql` or `list_tables` is provided. This aligns with the `GET_DOCUMENT_CONTEXT_TOOL` pattern (no required, handler validates).

    `GET_DOCUMENT_CONTEXT_TOOL`: Already has no `required` key, which is correct -- both `document_title` and `source_id` are optional (handler validates at least one). Leave as-is but verify the handler validation exists.

    `SEARCH_ENTITIES_TOOL`: Already has `"required": ["search_term"]` -- correct. Leave as-is.

    `GET_CHANGE_HISTORY_TOOL`: Review and fix if `required` is missing or incorrect. The tool should require `document_title` or `source_id` -- apply same pattern as `GET_DOCUMENT_CONTEXT_TOOL` if both are optional with handler validation, or add `required` if one is always needed.

    **CostTracker unknown model warning in `logging.py` (AGNT-05):**

    In `CostTracker._estimate_cost()`, replace the silent `pricing.get(model, pricing["claude-sonnet-4-5-20250514"])` fallback with:
    ```python
    rates = pricing.get(model)
    if rates is None:
        log = structlog.get_logger()
        log.warning("unknown_model_cost", message=f"Unknown model '{model}': using default cost estimate")
        rates = pricing["claude-sonnet-4-5-20250514"]
    ```
    The warning message format is a locked decision: `"Unknown model '{model}': using default cost estimate"`.

    **Full SHA-256 cache key hash in `cache.py` (AGNT-06):**

    Find the line that truncates the hash: `hashlib.sha256(raw.encode()).hexdigest()[:16]`
    Remove the `[:16]` slice to use the full 64-character hex digest:
    ```python
    digest = hashlib.sha256(raw.encode()).hexdigest()
    return f"search:{digest}"
    ```
    This changes Redis key length from `search:` + 16 chars to `search:` + 64 chars. No functional change, just collision resistance.
  </action>
  <verify>
    Run `python -m pytest tests/ -k "tool or cost or cache" -v` -- all tests pass.
    Run `python -c "from pam.agent.tools import QUERY_DATABASE_TOOL; assert QUERY_DATABASE_TOOL['input_schema'].get('required', []) == [], f'Expected empty required, got {QUERY_DATABASE_TOOL[\"input_schema\"].get(\"required\")}'; print('OK')"` -- QUERY_DATABASE_TOOL has empty required.
    Run `grep -n "hexdigest()" src/pam/common/cache.py` -- no `[:16]` truncation.
    Run `grep -n "Unknown model" src/pam/common/logging.py` -- warning message exists.
  </verify>
  <done>
    QUERY_DATABASE_TOOL has `required: []`. CostTracker logs `"Unknown model '{model}': using default cost estimate"` for unrecognized models. Cache key hash uses full SHA-256 (64 hex chars). All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Define SearchService Protocol, move hybrid_search log, update deps.py types</name>
  <files>
    src/pam/retrieval/search_protocol.py
    src/pam/retrieval/hybrid_search.py
    src/pam/retrieval/haystack_search.py
    src/pam/api/deps.py
  </files>
  <action>
    **Create SearchService Protocol in `search_protocol.py` (NEW file, AGNT-04):**

    Define a `typing.Protocol` class that captures the shared interface between `HybridSearchService` and `HaystackSearchService`:
    ```python
    from typing import Protocol, runtime_checkable
    from pam.retrieval.types import SearchResult  # or whatever the result type is

    @runtime_checkable
    class SearchService(Protocol):
        async def search(self, query: str, top_k: int = ..., ...) -> list[SearchResult]:
            ...

        async def search_from_query(self, ...) -> list[SearchResult]:
            ...
    ```

    Read both `hybrid_search.py` and `haystack_search.py` to determine the exact method signatures (params, return types). The Protocol must match what both classes already implement -- NO changes to those classes' method signatures.

    Use `@runtime_checkable` so `isinstance()` checks work if needed.

    Using Protocol (not ABC) per discretion recommendation: the search services are NOT subclassing anything today, and Protocol captures the "same shape" pattern via structural subtyping without requiring inheritance changes.

    **Update `deps.py` type hint (AGNT-04):**

    Change `get_search_service()` return type from `HybridSearchService` to `SearchService` (import from search_protocol.py). This makes the type hint correct regardless of whether Haystack backend is active.

    **Move hybrid_search log after reranking (AGNT-03):**

    In `hybrid_search.py`, find the `logger.info("hybrid_search", ...)` call that currently appears BEFORE the reranking block. Move it AFTER the reranking block so the logged `results` count reflects the post-rerank result set:

    ```python
    # CURRENT (log before rerank):
    logger.info("hybrid_search", query_length=len(query), results=len(results), top_k=top_k)
    if self.reranker and results:
        results = await self.reranker.rerank(query, results, top_k=top_k)

    # FIX (log after rerank):
    if self.reranker and results:
        results = await self.reranker.rerank(query, results, top_k=top_k)
    logger.info("hybrid_search", query_length=len(query), results=len(results), top_k=top_k)
    ```

    **Verify structural conformance:**

    After creating the Protocol, add a simple static assertion or test that both services conform:
    ```python
    # In a test file or at bottom of search_protocol.py:
    # Type-checking assertion (no runtime cost if using TYPE_CHECKING guard)
    if TYPE_CHECKING:
        _: SearchService = cast(HybridSearchService, None)  # type: ignore
        _: SearchService = cast(HaystackSearchService, None)  # type: ignore
    ```
    Or rely on `@runtime_checkable` and add a test: `assert isinstance(hybrid_service, SearchService)`.
  </action>
  <verify>
    Run `python -m pytest tests/ -k "search or hybrid" -v` -- all tests pass.
    Run `python -c "from pam.retrieval.search_protocol import SearchService; print('OK')"` -- Protocol imports.
    Run `python -c "from pam.retrieval.hybrid_search import HybridSearchService; from pam.retrieval.search_protocol import SearchService; assert issubclass(HybridSearchService, SearchService); print('Conforms')"` -- structural check passes (runtime_checkable).
    Run `grep -n 'logger.info.*hybrid_search' src/pam/retrieval/hybrid_search.py` -- log line appears AFTER any reranker call.
  </verify>
  <done>
    SearchService Protocol defined in search_protocol.py with runtime_checkable. Both HybridSearchService and HaystackSearchService structurally conform. deps.py get_search_service returns SearchService type. hybrid_search.py log emitted after reranking. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/ -v` -- full test suite passes
2. `grep -n "required" src/pam/agent/tools.py` -- QUERY_DATABASE_TOOL has `required: []`
3. `grep -n "Unknown model" src/pam/common/logging.py` -- CostTracker warning exists with model name interpolation
4. `grep -n "hexdigest" src/pam/common/cache.py` -- no `[:16]` truncation
5. `python -c "from pam.retrieval.search_protocol import SearchService"` -- Protocol importable
6. `grep -n "hybrid_search" src/pam/retrieval/hybrid_search.py` -- log appears after reranker block
</verification>

<success_criteria>
- QUERY_DATABASE_TOOL has `required: []` (not `required: ["sql"]`)
- CostTracker warns with model name on unknown models
- Cache key uses full SHA-256 digest (no truncation)
- SearchService Protocol exists and both search services conform structurally
- deps.py returns SearchService type from get_search_service
- hybrid_search log emitted after reranking
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-api-agent-hardening/03-03-SUMMARY.md`
</output>
