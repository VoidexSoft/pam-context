---
phase: 05-audit-gap-closure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/pam/api/deps.py
  - src/pam/agent/agent.py
  - src/pam/api/routes/search.py
  - src/pam/api/routes/chat.py
autonomous: true
requirements:
  - TOOL-02
  - AGNT-04

must_haves:
  truths:
    - "mypy runs clean on deps.py with zero `type: ignore[no-any-return]` comments"
    - "RetrievalAgent accepts SearchService Protocol, not HybridSearchService"
    - "search route uses SearchService Protocol, not HybridSearchService"
    - "Non-streaming /chat endpoint generates conversation_id when client sends null"
    - "SSE done event includes conversation_id as top-level field"
  artifacts:
    - path: "src/pam/api/deps.py"
      provides: "Type-safe app.state access via cast()"
      contains: "from typing import cast"
    - path: "src/pam/agent/agent.py"
      provides: "Protocol-typed search_service parameter"
      contains: "from pam.retrieval.search_protocol import SearchService"
    - path: "src/pam/api/routes/search.py"
      provides: "Protocol-typed search_service parameter"
      contains: "from pam.retrieval.search_protocol import SearchService"
    - path: "src/pam/api/routes/chat.py"
      provides: "Server-generated conversation_id with SSE wiring"
      contains: "import uuid"
  key_links:
    - from: "src/pam/api/deps.py"
      to: "src/pam/agent/agent.py"
      via: "get_agent passes SearchService to RetrievalAgent"
      pattern: "search_service: SearchService"
    - from: "src/pam/api/routes/chat.py"
      to: "SSE event_generator"
      via: "conversation_id injected into done event"
      pattern: 'chunk\["conversation_id"\]'
---

<objective>
Fix all backend type safety gaps and wire conversation_id through both API paths.

Purpose: Close TOOL-02 (mypy type safety in deps.py) and AGNT-04 (Protocol annotation in agent.py/search.py), plus generate conversation_id server-side and include it in both SSE done events and non-streaming ChatResponse.

Output: 4 backend files updated — deps.py uses cast(), agent.py and search.py use SearchService Protocol, chat.py generates and returns conversation_id.
</objective>

<execution_context>
@/Users/datnguyen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/datnguyen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-audit-gap-closure/05-RESEARCH.md
@src/pam/api/deps.py
@src/pam/agent/agent.py
@src/pam/api/routes/search.py
@src/pam/api/routes/chat.py
@src/pam/retrieval/search_protocol.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace type: ignore with cast() in deps.py and update Protocol annotations in agent.py + search.py</name>
  <files>
    src/pam/api/deps.py
    src/pam/agent/agent.py
    src/pam/api/routes/search.py
  </files>
  <action>
**deps.py — Replace 6 `# type: ignore[no-any-return]` with `cast()`:**

1. Add `cast` to the existing `typing` import: `from typing import TYPE_CHECKING, cast`
2. Replace each of the 6 return statements:
   - `get_es_client`: `return cast(AsyncElasticsearch, request.app.state.es_client)`
   - `get_embedder`: `return cast(OpenAIEmbedder, request.app.state.embedder)`
   - `get_search_service`: `return cast(SearchService, request.app.state.search_service)`
   - `get_reranker`: `return cast(BaseReranker | None, request.app.state.reranker)` (note the union type)
   - `get_duckdb_service`: `return cast("DuckDBService | None", request.app.state.duckdb_service)` (string form since DuckDBService is TYPE_CHECKING-only import)
   - `get_cache_service`: `return cast(CacheService | None, request.app.state.cache_service)`
3. In `get_agent()`, cast the two Any-typed app.state accesses:
   - `api_key=cast(str, request.app.state.anthropic_api_key)`
   - `model=cast(str, request.app.state.agent_model)`
4. Remove all `# type: ignore[no-any-return]` comments — there should be zero remaining.

**agent.py — Change HybridSearchService to SearchService Protocol:**

1. Replace import: `from pam.retrieval.hybrid_search import HybridSearchService` with `from pam.retrieval.search_protocol import SearchService`
2. Update `__init__` type annotation: `search_service: HybridSearchService` becomes `search_service: SearchService`
3. No other changes needed — the `self.search = search_service` assignment and all method calls on `self.search` work via Protocol structural subtyping.

**search.py — Change HybridSearchService to SearchService Protocol:**

1. Replace import: `from pam.retrieval.hybrid_search import HybridSearchService` with `from pam.retrieval.search_protocol import SearchService`
2. Update function parameter: `search_service: HybridSearchService = Depends(get_search_service)` becomes `search_service: SearchService = Depends(get_search_service)`
  </action>
  <verify>
Run: `cd /Users/datnguyen/Projects/AI-Projects/pam-context && python -m mypy src/pam/api/deps.py src/pam/agent/agent.py src/pam/api/routes/search.py --no-error-summary`

Expected: Zero errors. No `type: ignore` comments remaining in deps.py. Also verify with grep: `grep -n "type: ignore" src/pam/api/deps.py` returns nothing.
  </verify>
  <done>
- deps.py has zero `# type: ignore` comments and uses `cast()` for all 8 app.state accesses
- agent.py imports SearchService from search_protocol and uses it in __init__ signature
- search.py imports SearchService from search_protocol and uses it in route parameter
- mypy passes clean on all 3 files
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire conversation_id generation through both chat endpoints</name>
  <files>
    src/pam/api/routes/chat.py
  </files>
  <action>
**Non-streaming `/chat` endpoint:**

1. Add `import uuid` at top of file.
2. In the `chat()` handler, BEFORE the `agent.answer()` call, generate the ID:
   ```python
   conversation_id = request.conversation_id or str(uuid.uuid4())
   ```
3. Update the ChatResponse construction to use the generated `conversation_id` variable instead of `request.conversation_id`:
   ```python
   conversation_id=conversation_id,
   ```
   Currently line 71 reads `conversation_id=request.conversation_id` — this means first-turn requests with `conversation_id=None` return `null`. After the fix, first-turn requests return a server-generated UUID.

**Streaming `/chat/stream` endpoint:**

1. In `chat_stream()`, generate conversation_id the same way:
   ```python
   conversation_id = request.conversation_id or str(uuid.uuid4())
   ```
2. In `event_generator()`, inject conversation_id into the done event as a **top-level field** (per user decision — NOT nested in metadata):
   ```python
   async def event_generator():
       async for chunk in agent.answer_streaming(
           request.message,
           conversation_history=history,
           source_type=request.source_type,
       ):
           if chunk.get("type") == "done":
               chunk["conversation_id"] = conversation_id
           yield f"data: {json.dumps(chunk)}\n\n"
   ```
   This adds `conversation_id` at the same level as `type` and `metadata` in the done event JSON.

**DO NOT** modify agent.py to include conversation_id — it is an API-level concern that stays in the route handler.
  </action>
  <verify>
Run: `cd /Users/datnguyen/Projects/AI-Projects/pam-context && python -c "from pam.api.routes.chat import router; print('import OK')"` to verify no import errors.

Also run existing tests: `cd /Users/datnguyen/Projects/AI-Projects/pam-context && python -m pytest tests/test_api/ -x -q --timeout=30 2>&1 | tail -20`

Verify SSE shape by reading the updated chat.py and confirming:
1. `import uuid` is present
2. `conversation_id = request.conversation_id or str(uuid.uuid4())` appears in both handlers
3. `chunk["conversation_id"] = conversation_id` appears in event_generator
4. Non-streaming return uses `conversation_id=conversation_id` (not `request.conversation_id`)
  </verify>
  <done>
- Both `/chat` and `/chat/stream` generate a UUID when conversation_id is null on first turn
- SSE done event includes conversation_id as a top-level field (not nested in metadata)
- Non-streaming ChatResponse returns the generated conversation_id
- Agent remains stateless — no conversation_id awareness in agent.py
  </done>
</task>

</tasks>

<verification>
```bash
# 1. mypy clean on all modified files
cd /Users/datnguyen/Projects/AI-Projects/pam-context
python -m mypy src/pam/api/deps.py src/pam/agent/agent.py src/pam/api/routes/search.py src/pam/api/routes/chat.py --no-error-summary

# 2. No type: ignore comments remaining in deps.py
grep -c "type: ignore" src/pam/api/deps.py  # Should be 0

# 3. SearchService Protocol used (not HybridSearchService) in agent.py and search.py
grep "HybridSearchService" src/pam/agent/agent.py src/pam/api/routes/search.py  # Should return nothing

# 4. conversation_id generation present in both handlers
grep "uuid.uuid4()" src/pam/api/routes/chat.py  # Should return 2 lines

# 5. Existing backend tests still pass
python -m pytest tests/ -x -q --timeout=30 2>&1 | tail -5
```
</verification>

<success_criteria>
1. `python -m mypy src/pam/api/deps.py` shows zero errors and zero `type: ignore` comments
2. `grep HybridSearchService src/pam/agent/agent.py src/pam/api/routes/search.py` returns empty
3. `grep "uuid.uuid4()" src/pam/api/routes/chat.py` returns exactly 2 lines
4. All existing backend tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-audit-gap-closure/05-01-SUMMARY.md`
</output>
