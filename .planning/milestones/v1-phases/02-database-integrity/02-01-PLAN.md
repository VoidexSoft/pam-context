---
phase: 02-database-integrity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - alembic/versions/005_add_content_hash_index_and_role_constraint.py
  - src/pam/common/models.py
  - tests/test_common/test_config.py
autonomous: true

must_haves:
  truths:
    - "Document.content_hash column has a database index (idx_documents_content_hash)"
    - "UserProjectRole.role column rejects values outside viewer/editor/admin at the database level"
    - "Segment.document_id index is declared in the ORM model (index=True)"
    - "AssignRoleRequest.role rejects invalid values at the Pydantic layer with a clear enum error"
    - "test_env_override isolates environment completely (clear=True) so CI env vars cannot leak"
    - "Migration 005 creates the index using CREATE INDEX CONCURRENTLY (no table locks)"
  artifacts:
    - path: "alembic/versions/005_add_content_hash_index_and_role_constraint.py"
      provides: "Migration adding content_hash index and role CHECK constraint"
      contains: "postgresql_concurrently=True"
    - path: "src/pam/common/models.py"
      provides: "ORM model declarations with index=True and CheckConstraint"
      contains: "CheckConstraint"
    - path: "tests/test_common/test_config.py"
      provides: "Isolated test_env_override with clear=True"
      contains: "clear=True"
  key_links:
    - from: "alembic/versions/005_add_content_hash_index_and_role_constraint.py"
      to: "src/pam/common/models.py"
      via: "migration reflects ORM model declarations"
      pattern: "idx_documents_content_hash|ck_user_project_roles_role"
---

<objective>
Add missing database indexes and constraints, update ORM models to match, improve Pydantic role validation, and fix test environment isolation.

Purpose: Ensure database queries use proper indexes for performance, enforce role values at the database level to prevent invalid data, align ORM model declarations with actual schema, and prevent CI environment leaks in tests.

Output: One new Alembic migration (005), updated models.py with index/constraint declarations, updated AssignRoleRequest with Literal type, and fixed test_env_override with clear=True.
</objective>

<execution_context>
@/Users/datnguyen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/datnguyen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-database-integrity/02-RESEARCH.md

@src/pam/common/models.py
@alembic/versions/004_add_extracted_entities.py
@tests/test_common/test_config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Alembic migration 005 and update ORM model declarations</name>
  <files>
    alembic/versions/005_add_content_hash_index_and_role_constraint.py
    src/pam/common/models.py
  </files>
  <action>
**Create migration `alembic/versions/005_add_content_hash_index_and_role_constraint.py`:**

Use revision `"005"`, down_revision `"004"`. Follow the existing migration naming and structure from 001-004.

The `upgrade()` function must do TWO things in the correct order:

1. **CHECK constraint (transactional, runs first):** Call `op.create_check_constraint("ck_user_project_roles_role", "user_project_roles", "role IN ('viewer', 'editor', 'admin')")`. This runs inside the default transaction -- safe and fast.

2. **CONCURRENT index (non-transactional, runs second):** Use `with op.get_context().autocommit_block():` to exit the transaction, then call `op.create_index("idx_documents_content_hash", "documents", ["content_hash"], if_not_exists=True, postgresql_concurrently=True)`. The `autocommit_block()` commits the preceding CHECK constraint transaction, then runs in autocommit mode.

The `downgrade()` function reverses both: first drop index (inside `autocommit_block()` with `postgresql_concurrently=True, if_exists=True`), then `op.drop_constraint("ck_user_project_roles_role", "user_project_roles")`.

The ordering matters: CHECK constraint BEFORE autocommit_block in upgrade (because autocommit_block commits pending transaction). Index drop BEFORE constraint drop in downgrade.

**Update `src/pam/common/models.py`** to sync ORM declarations with actual schema:

1. **Segment.document_id** (DB-01): Add `index=True` to the existing `mapped_column()` call on `document_id`. The index `idx_segments_document_id` already exists in the database (created by migration 001), but the ORM model does not declare it. This keeps model and schema in sync.

2. **Document.content_hash** (DB-02): Add `index=True` to the existing `mapped_column(String(64))` call on `content_hash` in the `Document` class. This reflects the new index being created by migration 005.

3. **UserProjectRole.__table_args__** (DB-03): Add `CheckConstraint("role IN ('viewer', 'editor', 'admin')", name="ck_user_project_roles_role")` to the existing `__table_args__` tuple. The tuple currently has `UniqueConstraint(...)` and a dict -- insert the CheckConstraint before the dict (the dict must remain the last element in the tuple).

Do NOT add `from sqlalchemy import CheckConstraint` if it is already imported. Check existing imports first. If not imported, add it to the existing `from sqlalchemy import ...` line.
  </action>
  <verify>
1. `python -c "from alembic.versions import __path__; print('migration importable')"` -- or simply: `python -c "import importlib.util; spec = importlib.util.spec_from_file_location('m', 'alembic/versions/005_add_content_hash_index_and_role_constraint.py'); mod = importlib.util.find_spec is not None and print('OK')"`
2. `python -c "from pam.common.models import Document, Segment, UserProjectRole; print('models import OK')"` succeeds
3. `grep -c 'postgresql_concurrently=True' alembic/versions/005_add_content_hash_index_and_role_constraint.py` returns 2 (upgrade + downgrade)
4. `grep -c 'autocommit_block' alembic/versions/005_add_content_hash_index_and_role_constraint.py` returns 2 (upgrade + downgrade)
5. `grep 'index=True' src/pam/common/models.py` shows hits for both document_id and content_hash
6. `grep 'CheckConstraint' src/pam/common/models.py` shows the constraint in UserProjectRole.__table_args__
7. `ruff check alembic/versions/005_add_content_hash_index_and_role_constraint.py src/pam/common/models.py` passes
8. `pytest tests/ -x -q` passes (all existing tests still work)
  </verify>
  <done>
Migration 005 exists with CHECK constraint + CONCURRENT index in correct order. models.py declares index=True on Segment.document_id and Document.content_hash, and CheckConstraint on UserProjectRole.role. All tests pass and linting is clean.
  </done>
</task>

<task type="auto">
  <name>Task 2: Switch AssignRoleRequest.role to Literal type and fix test_env_override isolation</name>
  <files>
    src/pam/common/models.py
    tests/test_common/test_config.py
  </files>
  <action>
**Update `AssignRoleRequest.role` in `src/pam/common/models.py` (TOOL-03):**

Change the `role` field from:
```python
role: str = Field(pattern=r"^(viewer|editor|admin)$")
```
to:
```python
role: Literal["viewer", "editor", "admin"]
```

This requires adding `Literal` to the imports. Check if `from typing import Literal` or `from typing import ...` already exists. If there is a `from typing import ...` line, add `Literal` to it. If not, add `from typing import Literal`.

The `Field(pattern=...)` import may still be used elsewhere in models.py -- do NOT remove the `Field` import unless no other usage exists. Just remove it from this one field declaration.

Benefits: mypy understands valid values, OpenAPI generates a proper `enum` schema (not regex pattern), error messages are clearer ("Input should be 'viewer', 'editor' or 'admin'" instead of regex mismatch).

**Fix `test_env_override` in `tests/test_common/test_config.py` (TOOL-04):**

Change line 46 from:
```python
with patch.dict(os.environ, env, clear=False):
```
to:
```python
with patch.dict(os.environ, env, clear=True):
```

This prevents CI environment variables (like `DATABASE_URL`, `REDIS_URL`, etc.) from leaking into the test and causing unexpected values or false passes. The sibling test `test_default_values` already correctly uses `clear=True`.

Also check `test_cors_origins_list` at line 63 -- it also uses `clear=False`. Change it to `clear=True` as well for consistency, and add the required `OPENAI_API_KEY` and `ANTHROPIC_API_KEY` to its env dict if they are not already present (they are already present, so just change `clear=False` to `clear=True`).
  </action>
  <verify>
1. `python -c "from pam.common.models import AssignRoleRequest; import json; print(json.dumps(AssignRoleRequest.model_json_schema(), indent=2))"` shows `"enum": ["viewer", "editor", "admin"]` for the role field (not `"pattern"`)
2. `python -c "from pam.common.models import AssignRoleRequest; AssignRoleRequest(user_id='00000000-0000-0000-0000-000000000000', project_id='00000000-0000-0000-0000-000000000000', role='invalid')"` raises `ValidationError`
3. `grep -c 'clear=True' tests/test_common/test_config.py` returns 3 or more (all test methods use clear=True)
4. `grep 'clear=False' tests/test_common/test_config.py` returns nothing (no remaining clear=False)
5. `ruff check src/pam/common/models.py tests/test_common/test_config.py` passes
6. `mypy src/pam/common/models.py` passes
7. `pytest tests/test_common/test_config.py -v` passes all tests
8. `pytest tests/ -x -q` passes (full suite still works)
  </verify>
  <done>
AssignRoleRequest.role uses Literal["viewer", "editor", "admin"] with proper OpenAPI enum schema. All test methods in test_config.py use clear=True for environment isolation. All tests pass and linting is clean.
  </done>
</task>

</tasks>

<verification>
1. **DB-01 (Segment.document_id index):** `grep 'document_id.*index=True' src/pam/common/models.py` confirms ORM declaration (database index already exists from migration 001)
2. **DB-02 (Document.content_hash index):** Migration 005 creates `idx_documents_content_hash` with `postgresql_concurrently=True`; models.py declares `index=True`
3. **DB-03 (UserProjectRole.role CHECK):** Migration 005 creates `ck_user_project_roles_role` CHECK constraint; models.py declares `CheckConstraint` in `__table_args__`
4. **DB-04 (CREATE INDEX CONCURRENTLY):** Migration 005 uses `autocommit_block()` + `postgresql_concurrently=True`
5. **TOOL-03 (Literal type):** `AssignRoleRequest.role` is `Literal["viewer", "editor", "admin"]` -- schema shows enum, not pattern
6. **TOOL-04 (clear=True):** All `patch.dict` calls in test_config.py use `clear=True`
7. **No regressions:** `pytest tests/ -x -q` passes full test suite
</verification>

<success_criteria>
- Migration file `005_add_content_hash_index_and_role_constraint.py` exists and is syntactically valid
- `models.py` has `index=True` on `Segment.document_id` and `Document.content_hash`
- `models.py` has `CheckConstraint` in `UserProjectRole.__table_args__`
- `AssignRoleRequest.role` type is `Literal["viewer", "editor", "admin"]`
- All `patch.dict` calls in `test_config.py` use `clear=True`
- `ruff check` and `mypy` pass on all modified files
- All 450+ tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-database-integrity/02-01-SUMMARY.md`
</output>
